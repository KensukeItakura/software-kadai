<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIアシスタント付き時間割ツール</title>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: #f8f9fa; color: #212529; }
        h1, h2 { text-align: center; color: #495057; }
        .app-container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        .controls { text-align: center; padding: 1rem 0; display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; }
        button { padding: 10px 15px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; color: white; transition: background-color 0.3s, opacity 0.3s; }
        #save-btn { background-color: #007bff; }
        #reset-btn { background-color: #dc3545; }
        #open-course-master-modal-btn { background-color: #ffc107; color: #212529; }
        #recommend-task-btn { background-color: #9c27b0; }
        .main-nav { display: flex; justify-content: center; background-color: #e9ecef; padding: 0.5rem; border-radius: 8px; margin-bottom: 1.5rem; }
        .nav-tab { padding: 0.75rem 1.5rem; font-size: 1.1rem; font-weight: bold; color: #6c757d; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
        .nav-tab:hover { background-color: #dee2e6; }
        .nav-tab.active { background-color: #fff; color: #007bff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .content-section { display: none; }
        .content-section.active { display: block; }
        #timetable { width: 100%; border-collapse: collapse; background-color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.1); table-layout: fixed; margin-bottom: 30px; }
        th, td { border: 1px solid #dee2e6; padding: 8px; text-align: center; }
        thead th { background-color: #e9ecef; font-weight: bold; }
        tbody th { background-color: #f8f9fa; font-weight: bold; vertical-align: middle; line-height: 1.4; font-size: 14px; }
        tbody th small { font-weight: normal; font-size: 12px; color: #495057; }
        tbody td { height: 110px; vertical-align: top; text-align: left; position: relative; }
        tfoot th, tfoot td { background-color: #f8f9fa; padding: 10px 8px; vertical-align: middle; }
        .free-time-display { font-weight: bold; font-size: 18px; color: #28a745; cursor: pointer; }
        .free-time-display:hover { text-decoration: underline; }
        #open-lifetime-modal-btn { background-color: #6c757d; font-size: 14px; padding: 6px 12px; }
        .cell-content { padding-bottom: 25px; } .course-name { font-weight: bold; font-size: 16px; display: block; margin-bottom: 5px; } .cell-controls { position: absolute; bottom: 5px; right: 5px; } .details-btn, .link-btn { font-size: 12px; padding: 2px 6px; border-radius: 4px; margin-left: 4px; text-decoration: none; display: inline-block; } .details-btn { background-color: #6c757d; color: white; border: none; cursor: pointer; } .details-btn.has-details { background-color: #28a745; } .link-btn { background-color: #17a2b8; color: white; } .link-btn.hidden { display: none; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); animation: fadeIn 0.3s; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideIn 0.3s; }
        @keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
        @keyframes slideIn { from {transform: translateY(-50px)} to {transform: translateY(0)} }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #dee2e6; padding-bottom: 10px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; font-size: 22px; }
        .modal-header .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-body .form-group { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .modal-body label { font-weight: bold; flex-shrink: 0; width: 100px; }
        .modal-body select, .modal-body input, .modal-body textarea { flex-grow: 1; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .lunch-toggle-group label { width: auto; }
        #assignment-section { margin-top: 20px; border-top: 1px solid #dee2e6; padding-top: 15px; }
        .assignment-item { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .assignment-item input[type="text"] { flex-grow: 1; }
        .assignment-item .delete-assignment-btn, .master-course-item .delete-btn { background-color: #ff4d4d; color: white; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; line-height: 22px; text-align: center; }
        #add-assignment-btn, #add-master-course-btn { background-color: #28a745; font-size: 14px; padding: 5px 10px; }
        #modal-save-btn, #lifetime-modal-save-btn, #course-master-modal-save-btn { background-color: #6c757d; opacity: 0.65; cursor: not-allowed; }
        #modal-save-btn.active, #lifetime-modal-save-btn.active, #course-master-modal-save-btn.active { background-color: #007bff; opacity: 1; cursor: pointer; }
        .modal-tabs { display: flex; border-bottom: 1px solid #dee2e6; margin-bottom: 20px; }
        .tab-link { padding: 10px 15px; cursor: pointer; border: 1px solid transparent; border-bottom: none; background: #f1f1f1; }
        .tab-link.active { background-color: white; border-color: #dee2e6 #dee2e6 white; border-radius: 5px 5px 0 0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        select:disabled { background-color: #e9ecef; cursor: not-allowed; opacity: 0.7; }
        .list-container { max-width: 900px; margin: 30px auto; }
        .list-table { width: 100%; border-collapse: collapse; }
        .list-table th, .list-table td { border: 1px solid #ddd; text-align: left; padding: 4px 8px; }
        .list-table th { background-color: #e9ecef; }
        .list-table tr.completed td:not(:last-child):not(:nth-last-child(2)), #todo-table tr.completed span { text-decoration: line-through; color: #999; }
        #assignment-list { table-layout: fixed; }
        #assignment-list th:nth-child(1) { width: 30%; } #assignment-list th:nth-child(2) { width: 45%; } #assignment-list th:nth-child(3) { width: 15%; } #assignment-list th:nth-child(4) { width: 10%; text-align: center; }
        #assignment-list td:nth-child(4) { text-align: center; vertical-align: middle; }
        #todo-input-form { display: flex; gap: 10px; margin-bottom: 15px; }
        #todo-input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        #add-todo-btn { background-color: #28a745; padding: 8px 15px; }
        #todo-table th:nth-child(1) { width: 70%; } #todo-table th:nth-child(2), #todo-table th:nth-child(3) { width: 15%; text-align: center; }
        #todo-table td { vertical-align: middle; } #todo-table td:nth-child(2), #todo-table td:nth-child(3) { text-align: center; }
        .delete-btn { background: none; border: none; color: #ff4d4d; font-size: 20px; cursor: pointer; padding: 0 5px;}
        #course-master-modal .paste-container { display: flex; gap: 10px; margin-bottom: 10px; }
        #course-master-modal .paste-container textarea { width: 50%; height: 150px; }
        #master-course-list .master-course-item { display: flex; gap: 10px; margin-bottom: 10px; }
        #master-course-list input { flex: 1; }
        #notification-bell { position: fixed; top: 20px; left: 20px; font-size: 24px; cursor: pointer; z-index: 1001; }
        #notification-badge { position: absolute; top: -5px; right: -10px; background-color: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px; font-weight: bold; display: none; }
        #notification-modal .notification-item, #recommendation-modal .recommendation-item { padding: 10px; border-bottom: 1px solid #eee; }
        #notification-modal .course-name, #recommendation-modal .recommendation-item strong { font-weight: bold; }
        #notification-modal .due-date { color: #dc3545; font-weight: bold; margin-left: 10px;}
        #recommendation-modal .recommendation-reason { margin-top: 5px; color: #6c757d; }
    </style>
</head>
<body>
    <div id="notification-bell"><span>??</span><span id="notification-badge"></span></div>
    <div class="app-container">
        <h1>学生生活統合管理ツール</h1>
        <nav class="main-nav"><div class="nav-tab active" data-tab="timetable">時間割</div><div class="nav-tab" data-tab="tasks">課題・ToDo</div></nav>
        <div class="controls"><button id="open-course-master-modal-btn">科目・教員設定</button><button id="recommend-task-btn">次に何をすべき？</button><button id="save-btn">ブラウザに保存</button><button id="reset-btn">リセット</button></div>
        <div id="timetable-section" class="content-section active"><table id="timetable"><thead><tr><th></th><th>月</th><th>火</th><th>水</th><th>木</th><th>金</th><th>土</th></tr></thead><tbody></tbody><tfoot></tfoot></table></div>
        <div id="tasks-section" class="content-section"><div class="list-container"><h2>課題リスト</h2><table id="assignment-list" class="list-table"><thead><tr><th>科目名</th><th>課題内容</th><th>締切</th><th>完了</th></tr></thead><tbody></tbody></table></div><div class="list-container"><h2>やりたいことリスト</h2><div id="todo-input-form"><input type="text" id="todo-input" placeholder="新しいタスクを追加"><button id="add-todo-btn">追加</button></div><table id="todo-table" class="list-table"><thead><tr><th>内容</th><th>完了</th><th>削除</th></tr></thead><tbody></tbody></table></div></div>
        <p class="note">「科目・教員設定」からリストを編集し、各コマの「詳細」で選択・入力してください。</p>
    </div>
    <div id="syllabus-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="modal-title">詳細情報</h2><span class="close-btn">×</span></div><div class="modal-body"><input type="hidden" id="modal-cell-id"><div class="form-group"><label for="course-select">講義を選択</label><select id="course-select"><option value="">-- 手入力 --</option></select></div><hr><div class="form-group"><label for="modal-course-name">科目名</label><input type="text" id="modal-course-name"></div><div class="form-group"><label for="modal-professor">担当教員</label><input type="text" id="modal-professor"></div><div class="form-group"><label for="modal-url">シラバスURL</label><input type="url" id="modal-url"></div><div class="form-group"><label for="modal-memo">メモ</label><textarea id="modal-memo"></textarea></div><div id="assignment-section"><h3>課題</h3><div id="assignments-container"></div><button id="add-assignment-btn">課題を追加</button></div></div><div class="modal-footer"><button id="modal-save-btn">保存して閉じる</button></div></div></div>
    <div id="lifetime-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>生活時間の設定</h2><span class="close-btn">×</span></div><div id="lifetime-modal-body" class="modal-body"></div><div class="modal-footer"><button id="lifetime-modal-save-btn">保存して閉じる</button></div></div></div>
    <div id="course-master-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>科目・教員マスタ設定</h2><span class="close-btn">×</span></div><div class="modal-body"><p>左に科目名、右に教員名の一覧をそれぞれ貼り付けてください。</p><div class="paste-container"> <textarea id="course-paste-area" placeholder="ここに科目名リストをペースト..."></textarea> <textarea id="prof-paste-area" placeholder="ここに教員名リストをペースト..."></textarea></div><button id="parse-courses-btn">取り込み</button><hr><h3>取り込み/編集</h3><div id="master-course-list"></div><button id="add-master-course-btn">手動で追加</button></div><div class="modal-footer"><button id="course-master-modal-save-btn">この内容で保存</button></div></div></div>
    <div id="notification-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>通知リスト</h2><span class="close-btn">×</span></div><div id="notification-content" class="modal-body"></div></div></div>
    <div id="recommendation-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>AIからの提案</h2><span class="close-btn">×</span></div><div id="recommendation-content" class="modal-body"></div></div></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const timetableBody = document.querySelector('#timetable tbody'), timetableFoot = document.querySelector('#timetable tfoot'), saveBtn = document.getElementById('save-btn'), resetBtn = document.getElementById('reset-btn'), syllabusModal = document.getElementById('syllabus-modal'), lifetimeModal = document.getElementById('lifetime-modal'), courseMasterModal = document.getElementById('course-master-modal'), syllabusModalSaveBtn = document.getElementById('modal-save-btn'), lifetimeModalSaveBtn = document.getElementById('lifetime-modal-save-btn'), courseMasterModalSaveBtn = document.getElementById('course-master-modal-save-btn'), assignmentListBody = document.querySelector('#assignment-list tbody'), todoInput = document.getElementById('todo-input'), addTodoBtn = document.getElementById('add-todo-btn'), todoTableBody = document.querySelector('#todo-table tbody'), addAssignmentBtn = document.getElementById('add-assignment-btn'), notificationBell = document.getElementById('notification-bell'), notificationBadge = document.getElementById('notification-badge'), notificationModal = document.getElementById('notification-modal'), notificationContent = document.getElementById('notification-content'), recommendTaskBtn = document.getElementById('recommend-task-btn'), recommendationModal = document.getElementById('recommendation-modal'), recommendationContent = document.getElementById('recommendation-content');
        const syllabusStorageKey = 'mySyllabusTimetableData_v4', lifeTimeStorageKey = 'myLifeTimeData_v4', todoStorageKey = 'myTodoListData_v1', courseMasterStorageKey = 'myCourseMasterData_v3';
        let timetableData = {}, lifeTimeData = {}, todoList = [], courseMaster = [];
        let initialSyllabusModalState = {}, initialLifetimeModalState = {};
        const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat'], dayNames = { mon: '月', tue: '火', wed: '水', thu: '木', fri: '金', sat: '土' };
        const periods = [ { num: 1, time: '09:00～10:30' }, { num: 2, time: '10:40～12:10' }, { num: 3, time: '13:20～14:50' }, { num: 4, time: '15:00～16:30' }, { num: 5, time: '16:40～18:10' }, { num: 6, time: '18:20～19:50' }];
        const CLASS_DURATION_MINUTES = 90; const ACTIVITIES = { breakfast: '朝食', dinner: '夕食', bath: '入浴', parttime: 'バイト' };
        
        const getDefaultLifeTimeData = () => { const data = { isLunchEnabled: true, days: {} }; days.forEach(d => { data.days[d] = { wakeup: '07:00', sleep: '23:00', lunch: '70', breakfast: '30', dinner: '60', bath: '30', parttime: '0' }; }); return JSON.parse(JSON.stringify(data)); };
        
        const createTable = () => { timetableBody.innerHTML = periods.map(p => `<tr><th>${p.num}<br><small>${p.time}</small></th>${days.map(d => `<td id="cell-${d}-${p.num}"><div class="cell-content"><span class="course-name"></span></div><div class="cell-controls"><a href="#" class="link-btn hidden" target="_blank" rel="noopener noreferrer">URL</a><button class="details-btn">詳細</button></div></td>`).join('')}</tr>`).join(''); };
        const createFooter = () => { timetableFoot.innerHTML = `<tr><th><button id="open-lifetime-modal-btn">生活時間の設定</button></th>${days.map(d => `<td><span class="free-time-display" data-day="${d}">-</span></td>`).join('')}</tr>`; };
        const createLifetimeModal = () => { const timeOpts = Array.from({length: 48}, (_, i) => `<option value="${`${Math.floor(i/2)}`.padStart(2,'0')}:${i%2===0?'00':'30'}">${`${Math.floor(i/2)}`.padStart(2,'0')}:${i%2===0?'00':'30'}</option>`).join(''); const durOpts = Array.from({length: 9}, (_, i) => `<option value="${i*15}">${i*15} 分</option>`).join(''); const parttimeOpts = Array.from({length: 17}, (_, i) => `<option value="${i*30}">${Math.floor(i/2)}時間${i%2===0?'':'30分'}</option>`).join(''); let tabsHTML = '<div class="modal-tabs">'; let contentHTML = ''; days.forEach((day, index) => { tabsHTML += `<div class="tab-link ${index===0?'active':''}" data-tab="${day}">${dayNames[day]}</div>`; contentHTML += `<div id="tab-${day}" class="tab-content ${index===0?'active':''}"><div class="form-group"><label for="lt-wakeup-${day}">起床時間</label><select id="lt-wakeup-${day}">${timeOpts}</select></div><div class="form-group"><label for="lt-sleep-${day}">就寝時間</label><select id="lt-sleep-${day}">${timeOpts}</select></div><div class="form-group"><label for="lt-lunch-${day}">昼食<small>(2-3限)</small></label><select id="lt-lunch-${day}">${durOpts}</select></div><div class="form-group"><label for="lt-breakfast-${day}">朝食</label><select id="lt-breakfast-${day}">${durOpts}</select></div><div class="form-group"><label for="lt-dinner-${day}">夕食</label><select id="lt-dinner-${day}">${durOpts}</select></div><div class="form-group"><label for="lt-bath-${day}">入浴</label><select id="lt-bath-${day}">${durOpts}</select></div><div class="form-group"><label for="lt-parttime-${day}">バイト</label><select id="lt-parttime-${day}">${parttimeOpts}</select></div></div>`; }); const lunchToggleHTML = `<div class="form-group lunch-toggle-group"><label for="lt-lunch-toggle">昼食計算を有効化</label><input type="checkbox" id="lt-lunch-toggle"></div><hr>`; document.getElementById('lifetime-modal-body').innerHTML = lunchToggleHTML + tabsHTML + '</div>' + contentHTML; };
        const renderTodoList = () => { todoTableBody.innerHTML = todoList.map(todo => `<tr class="${todo.completed ? 'completed' : ''}" data-id="${todo.id}"><td><span>${todo.text}</span></td><td><input type="checkbox" ${todo.completed ? 'checked' : ''}></td><td><button class="delete-btn">×</button></td></tr>`).join(''); };
        const addTodo = () => { const text = todoInput.value.trim(); if (text) { todoList.push({ id: Date.now(), text, completed: false }); todoInput.value = ''; renderTodoList(); } };
        
        // ▼▼▼▼▼ ここからJavaScriptの修正箇所 ▼▼▼▼▼
        const callAI = async (prompt, button) => {
            if(button) { button.textContent = 'AI考え中...'; button.disabled = true; }
            try {
                // Hugging Faceの無料APIエンドポイント
                const response = await fetch("https://api-inference.huggingface.co/models/microsoft/DialoGPT-large", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        "inputs": { "text": prompt },
                        "parameters": { "max_new_tokens": 150 }
                    })
                });

                if (!response.ok) throw new Error(`APIエラー: ${response.status}`);
                const data = await response.json();
                
                // 応答の形式がモデルによって異なるため、柔軟に取得
                const aiResponse = data[0]?.generated_text || "提案を取得できませんでした。";
                
                // AIの応答からプロンプト部分を削除する（モデルによる）
                return aiResponse.replace(prompt, "").trim();

            } catch (error) {
                alert('AIとの通信に失敗しました。時間をおいて再度お試しください。');
                console.error(error);
                return null;
            } finally {
                if(button) { button.textContent = '次に何をすべき？'; button.disabled = false; }
            }
        };
        // ▲▲▲▲▲ ここまでJavaScriptの修正箇所 ▲▲▲▲▲

        const checkNotifications = async () => { const today = new Date(); const tomorrow = new Date(); tomorrow.setDate(today.getDate() + 1); const todayStr = today.toISOString().split('T')[0]; const tomorrowStr = tomorrow.toISOString().split('T')[0]; let dueAssignments = []; for (const cellId in timetableData) { const cellData = timetableData[cellId]; if (cellData.assignments) { const upcoming = cellData.assignments.filter(a => !a.completed && (a.dueDate === todayStr || a.dueDate === tomorrowStr)); if (upcoming.length > 0) { dueAssignments = dueAssignments.concat(upcoming.map(a => ({...a, courseName: cellData.name || '（科目名未設定）'}))); } } } if (dueAssignments.length > 0) { notificationBadge.textContent = dueAssignments.length; notificationBadge.style.display = 'block'; const prompt = `あなたは優秀な学生アシスタントです。以下の締切が近い課題について、学生が行動を起こしたくなるような、簡潔で具体的なアドバイスをそれぞれ1文で生成してください。\n\n${dueAssignments.map(a => `- ${a.courseName}の「${a.text}」（締切: ${a.dueDate}）`).join('\n')}`; const aiAdvice = await callAI(prompt, null); notificationContent.innerHTML = dueAssignments.map((a, i) => `<div class="notification-item"><span class="course-name">${a.courseName}:</span><span>${a.text}</span><span class="due-date">${a.dueDate === todayStr ? '本日締切' : '明日締切'}</span>${aiAdvice ? `<p style="color: #6f42c1; margin-top: 5px;"><strong>AIアドバイス:</strong> ${aiAdvice.split('\n')[i+1] || ''}</p>` : ''}</div>`).join(''); } else { notificationBadge.style.display = 'none'; notificationContent.innerHTML = '<p>締切が本日または明日の課題はありません。</p>'; } };
        const recommendNextTask = async () => { recommendationContent.innerHTML = '<p>AIがあなたの状況を分析しています...</p>'; recommendationModal.style.display = 'block'; const now = new Date(); const dayIndex = (now.getDay() + 6) % 7; const dayKey = days[dayIndex]; const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`; let context = `現在の時刻は${dayNames[dayKey]}曜日の${currentTime}です。\n`; context += `今日の時間割と予定は以下の通りです：\n`; periods.forEach(p => { const cellId = `cell-${dayKey}-${p.num}`; if (timetableData[cellId]?.name) { context += `- ${p.time}: ${timetableData[cellId].name}\n`; } }); Object.entries(ACTIVITIES).forEach(([key, label]) => { const duration = parseInt(lifeTimeData.days[dayKey][key], 10) || 0; if(duration > 0) context += `- ${label}の時間: ${duration}分\n`; }); const uncompletedAssignments = []; Object.values(timetableData).forEach(cell => { cell.assignments?.forEach(a => { if(!a.completed) uncompletedAssignments.push(`${cell.name}の「${a.text}」（締切: ${a.dueDate || '未設定'}）`); }); }); if(uncompletedAssignments.length > 0) context += `\n未完了の課題リスト:\n- ${uncompletedAssignments.join('\n- ')}\n`; const uncompletedTodos = todoList.filter(t => !t.completed).map(t => t.text); if(uncompletedTodos.length > 0) context += `\n未完了のToDoリスト:\n- ${uncompletedTodos.join('\n- ')}\n`; const prompt = `あなたは優秀なパーソナルアシスタントです。以下のユーザーの状況を分析し、今この瞬間に取り組むべき最も効果的で具体的なタスクを1つだけ提案してください。なぜそのタスクを推奨するのか、簡潔な理由も添えてください。\n\n【ユーザーの状況】\n${context}\n\n【提案】\n`; const recommendation = await callAI(prompt, recommendTaskBtn); if(recommendation) { recommendationContent.innerHTML = recommendation.replace(/\n/g, '<br>'); } else { recommendationContent.innerHTML = '<p>提案の生成に失敗しました。</p>'; } };
        const getCurrentSyllabusModalState = () => { const assignments = Array.from(document.querySelectorAll('#assignments-container .assignment-item')).map(item => ({ text: item.querySelector('.assignment-text').value, dueDate: item.querySelector('.assignment-due-date').value })); return { name: document.getElementById('modal-course-name').value, professor: document.getElementById('modal-professor').value, url: document.getElementById('modal-url').value, memo: document.getElementById('modal-memo').value, assignments: JSON.stringify(assignments) }; };
        const checkSyllabusModalChanges = () => { const hasChanged = JSON.stringify(initialSyllabusModalState) !== JSON.stringify(getCurrentSyllabusModalState()); if (hasChanged) syllabusModalSaveBtn.classList.add('active'); else syllabusModalSaveBtn.classList.remove('active'); };
        const getCurrentLifetimeModalState = () => { const state = { isLunchEnabled: document.getElementById('lt-lunch-toggle').checked, days: {} }; days.forEach(day => { state.days[day] = { wakeup: document.getElementById(`lt-wakeup-${day}`).value, sleep: document.getElementById(`lt-sleep-${day}`).value, lunch: document.getElementById(`lt-lunch-${day}`).disabled ? initialLifetimeModalState.days[day].lunch : document.getElementById(`lt-lunch-${day}`).value }; Object.keys(ACTIVITIES).forEach(key => { state.days[day][key] = document.getElementById(`lt-${key}-${day}`).value; }); }); return state; };
        const checkLifetimeModalChanges = () => { const hasChanged = JSON.stringify(initialLifetimeModalState) !== JSON.stringify(getCurrentLifetimeModalState()); if (hasChanged) lifetimeModalSaveBtn.classList.add('active'); else lifetimeModalSaveBtn.classList.remove('active'); };
        const renderAssignmentsInModal = (assignments = []) => { const container = document.getElementById('assignments-container'); container.innerHTML = ''; assignments.forEach(a => { const item = document.createElement('div'); item.className = 'assignment-item'; item.dataset.id = a.id; item.innerHTML = `<input type="text" class="assignment-text" placeholder="課題内容" value="${a.text}"><input type="date" class="assignment-due-date" value="${a.dueDate}"><button type="button" class="delete-assignment-btn">×</button>`; container.appendChild(item); }); };
        const addAssignment = () => { const container = document.getElementById('assignments-container'); const item = document.createElement('div'); item.className = 'assignment-item'; item.dataset.id = Date.now(); item.innerHTML = `<input type="text" class="assignment-text" placeholder="課題内容"><input type="date" class="assignment-due-date"><button type="button" class="delete-assignment-btn">×</button>`; container.appendChild(item); checkSyllabusModalChanges(); };
        const renderAssignmentList = () => { let allAssignments = []; Object.entries(timetableData).forEach(([cellId, cellData]) => { cellData.assignments?.forEach(a => allAssignments.push({ ...a, courseName: cellData.name || '（科目名未設定）', cellId })); }); allAssignments.sort((a, b) => (a.dueDate || '9999-12-31').localeCompare(b.dueDate || '9999-12-31')); assignmentListBody.innerHTML = allAssignments.map(a => `<tr class="${a.completed ? 'completed' : ''}">${['courseName','text','dueDate'].map(k=>`<td>${a[k]||'未設定'}</td>`).join('')}<td><input type="checkbox" class="complete-checkbox" data-cell-id="${a.cellId}" data-assignment-id="${a.id}" ${a.completed?'checked':''}></td></tr>`).join(''); checkNotifications(); };
        const openSyllabusModal = (cellId) => { const data = timetableData[cellId] || {}; const [_, day, period] = cellId.split('-'); document.getElementById('modal-title').textContent = `${dayNames[day]}曜 ${period}限`; document.getElementById('modal-cell-id').value = cellId; document.getElementById('modal-course-name').value = data.name || ''; document.getElementById('modal-professor').value = data.professor || ''; document.getElementById('modal-url').value = data.url || ''; document.getElementById('modal-memo').value = data.memo || ''; document.getElementById('course-select').value = ""; renderAssignmentsInModal(data.assignments); initialSyllabusModalState = getCurrentSyllabusModalState(); syllabusModalSaveBtn.classList.remove('active'); syllabusModal.style.display = 'block'; };
        const saveSyllabusModalData = () => { const cellId = document.getElementById('modal-cell-id').value; if (!cellId) return; const data = { name: document.getElementById('modal-course-name').value.trim(), professor: document.getElementById('modal-professor').value.trim(), url: document.getElementById('modal-url').value.trim(), memo: document.getElementById('modal-memo').value.trim(), assignments: Array.from(document.querySelectorAll('#assignments-container .assignment-item')).map(item => { const existing = timetableData[cellId]?.assignments.find(a => a.id == item.dataset.id) || {}; return { id: parseInt(item.dataset.id), text: item.querySelector('.assignment-text').value.trim(), dueDate: item.querySelector('.assignment-due-date').value, completed: existing.completed || false }; }).filter(a => a.text) }; const hasAnyData = data.name || data.professor || data.url || data.memo || (data.assignments && data.assignments.length > 0); if (hasAnyData) timetableData[cellId] = data; else delete timetableData[cellId]; updateCellDisplay(cellId, timetableData[cellId]); renderAssignmentList(); calculateAllFreeTimes(); syllabusModal.style.display = 'none'; };
        const updateLunchUI = () => { days.forEach(day => { document.getElementById(`lt-lunch-${day}`).disabled = !document.getElementById('lt-lunch-toggle').checked; }); };
        const openLifetimeModal = () => { document.getElementById('lt-lunch-toggle').checked = lifeTimeData.isLunchEnabled; updateLunchUI(); days.forEach(day => { const dayData = lifeTimeData.days[day]; document.getElementById(`lt-wakeup-${day}`).value = dayData.wakeup; document.getElementById(`lt-sleep-${day}`).value = dayData.sleep; document.getElementById(`lt-lunch-${day}`).value = dayData.lunch; Object.keys(ACTIVITIES).forEach(key => document.getElementById(`lt-${key}-${day}`).value = dayData[key]); }); initialLifetimeModalState = getCurrentLifetimeModalState(); lifetimeModalSaveBtn.classList.remove('active'); lifetimeModal.style.display = 'block'; };
        const saveLifetimeModalData = () => { lifeTimeData = getCurrentLifetimeModalState(); calculateAllFreeTimes(); lifetimeModal.style.display = 'none'; };
        const updateCellDisplay = (cellId, data) => { const cell = document.getElementById(cellId); if (!cell) return; const courseNameEl = cell.querySelector('.course-name'), detailsBtn = cell.querySelector('.details-btn'), linkBtn = cell.querySelector('.link-btn'); const hasDetails = data && (data.name?.trim() || data.professor?.trim() || data.url?.trim() || data.memo?.trim() || (data.assignments && data.assignments.length > 0)); if (hasDetails) { courseNameEl.textContent = data.name || '（詳細あり）'; detailsBtn.classList.add('has-details'); if (data.url) { linkBtn.href = data.url; linkBtn.classList.remove('hidden'); } else { linkBtn.classList.add('hidden'); } } else { courseNameEl.textContent = ''; detailsBtn.classList.remove('has-details'); linkBtn.classList.add('hidden'); } };
        const timeToMinutes = (t) => {if(!t) return 0; const [h,m]=t.split(':').map(Number);return h*60+(m||0);}; const minutesToTimeStr = (m) => {if(isNaN(m)||m<0)return'0時間0分';return`${Math.floor(m/60)}時間${m%60}分`;};
        const calculateFreeTime = (day) => { const dayData = lifeTimeData.days[day]; let activeMins = timeToMinutes(dayData.sleep) - timeToMinutes(dayData.wakeup); if(activeMins < 0) activeMins += 1440; const classMins = periods.reduce((sum, p) => sum + (timetableData[`cell-${day}-${p.num}`]?.name ? CLASS_DURATION_MINUTES : 0), 0); let activityMins = 0; if(lifeTimeData.isLunchEnabled && timetableData[`cell-${day}-2`]?.name && timetableData[`cell-${day}-3`]?.name) { activityMins += parseInt(dayData.lunch, 10) || 0; } Object.keys(ACTIVITIES).forEach(key => { activityMins += parseInt(dayData[key], 10) || 0; }); document.getElementById(`freetime-${day}`).textContent = minutesToTimeStr(activeMins - classMins - activityMins); };
        const calculateAllFreeTimes = () => days.forEach(calculateFreeTime);
        const populateCourseSelect = () => { const select = document.getElementById('course-select'); select.innerHTML = '<option value="">-- 手入力 --</option>'; courseMaster.forEach((course, index) => { const option = document.createElement('option'); option.value = index; option.textContent = `${course.name} - ${course.professor || '教員未設定'}`; select.appendChild(option); }); };
        const renderCourseMasterModal = () => { const container = document.getElementById('master-course-list'); container.innerHTML = courseMaster.map((course, index) => `<div class="master-course-item" data-index="${index}"><input type="text" class="master-course-name" placeholder="科目名" value="${course.name}"><input type="text" class="master-course-prof" placeholder="担当教員名" value="${course.professor || ''}"><button class="delete-btn">×</button></div>`).join(''); };
        const parsePastedCourseText = () => { const courseLines = document.getElementById('course-paste-area').value.split('\n').map(line => line.trim()).filter(line => line); const profLines = document.getElementById('prof-paste-area').value.split('\n').map(line => line.trim()).filter(line => line); let tempCourseMaster = courseLines.map((name, index) => ({ name, professor: profLines[index] || '' })); document.getElementById('master-course-list').innerHTML = tempCourseMaster.map(c => `<div class="master-course-item"><input type="text" class="master-course-name" value="${c.name}"><input type="text" class="master-course-prof" value="${c.professor}"><button class="delete-btn">×</button></div>`).join(''); courseMasterModalSaveBtn.classList.add('active'); };
        const saveCourseMasterData = () => { courseMaster = []; document.querySelectorAll('#master-course-list .master-course-item').forEach(item => { const name = item.querySelector('.master-course-name').value.trim(); if(name) courseMaster.push({ name, professor: item.querySelector('.master-course-prof').value.trim() }); }); populateCourseSelect(); courseMasterModal.style.display = 'none'; };
        const saveData = () => { localStorage.setItem(syllabusStorageKey, JSON.stringify(timetableData)); localStorage.setItem(lifeTimeStorageKey, JSON.stringify(lifeTimeData)); localStorage.setItem(todoStorageKey, JSON.stringify(todoList)); localStorage.setItem(courseMasterStorageKey, JSON.stringify(courseMaster)); alert('全てのデータを保存しました。'); };
        const loadData = () => { const savedSyllabus = localStorage.getItem(syllabusStorageKey); timetableData = savedSyllabus ? JSON.parse(savedSyllabus) : {}; const savedLifeTime = localStorage.getItem(lifeTimeStorageKey); lifeTimeData = savedLifeTime ? JSON.parse(savedLifeTime) : getDefaultLifeTimeData(); const savedTodo = localStorage.getItem(todoStorageKey); todoList = savedTodo ? JSON.parse(savedTodo) : []; const savedCourseMaster = localStorage.getItem(courseMasterStorageKey); courseMaster = savedCourseMaster ? JSON.parse(savedCourseMaster) : []; Object.keys(timetableData).forEach(id => updateCellDisplay(id, timetableData[id])); renderAssignmentList(); renderTodoList(); calculateAllFreeTimes(); populateCourseSelect(); checkNotifications(); };
        const resetData = () => { if (confirm('すべての内容をリセットします。よろしいですか？')) { timetableData = {}; lifeTimeData = getDefaultLifeTimeData(); todoList = []; courseMaster = []; localStorage.clear(); document.querySelectorAll('#timetable tbody td').forEach(cell => updateCellDisplay(cell.id, null)); renderAssignmentList(); renderTodoList(); calculateAllFreeTimes(); populateCourseSelect(); checkNotifications(); alert('リセットしました。'); } };
        
        createTable(); createFooter(); createLifetimeModal();
        saveBtn.addEventListener('click', saveData);
        resetBtn.addEventListener('click', resetData);
        mainNav.addEventListener('click', (e) => { if (e.target.classList.contains('nav-tab')) { const targetTab = e.target.dataset.tab; mainNav.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active')); e.target.classList.add('active'); contentSections.forEach(section => { if (section.id === `${targetTab}-section`) { section.classList.add('active'); } else { section.classList.remove('active'); } }); } });
        timetableBody.addEventListener('click', e => { if (e.target.classList.contains('details-btn')) openSyllabusModal(e.target.closest('td').id); });
        syllabusModal.querySelector('.modal-body').addEventListener('input', checkSyllabusModalChanges);
        document.getElementById('course-select').addEventListener('change', (e) => { const selectedIndex = e.target.value; if (selectedIndex !== "") { const course = courseMaster[selectedIndex]; document.getElementById('modal-course-name').value = course.name; document.getElementById('modal-professor').value = course.professor || ''; checkSyllabusModalChanges(); } });
        addAssignmentBtn.addEventListener('click', addAssignment);
        document.getElementById('assignments-container').addEventListener('click', e => { if (e.target.classList.contains('delete-assignment-btn')) { e.target.closest('.assignment-item').remove(); checkSyllabusModalChanges(); } });
        syllabusModalSaveBtn.addEventListener('click', saveSyllabusModalData);
        assignmentListBody.addEventListener('change', e => { if (e.target.classList.contains('complete-checkbox')) { const { cellId, assignmentId } = e.target.dataset; const assignment = timetableData[cellId]?.assignments.find(a => a.id == assignmentId); if (assignment) { assignment.completed = e.target.checked; renderAssignmentList(); } } });
        document.getElementById('open-lifetime-modal-btn').addEventListener('click', openLifetimeModal);
        lifetimeModalSaveBtn.addEventListener('click', saveLifetimeModalData);
        document.getElementById('lifetime-modal-body').addEventListener('change', (e) => { if (e.target.id === 'lt-lunch-toggle') { updateLunchUI(); } checkLifetimeModalChanges(); });
        document.querySelector('#lifetime-modal .modal-tabs').addEventListener('click', e => { if (e.target.classList.contains('tab-link')) { document.querySelectorAll('#lifetime-modal .tab-link, #lifetime-modal .tab-content').forEach(el => el.classList.remove('active')); e.target.classList.add('active'); document.getElementById(`tab-${e.target.dataset.tab}`).classList.add('active'); } });
        document.getElementById('open-course-master-modal-btn').addEventListener('click', () => { renderCourseMasterModal(); courseMasterModal.style.display = 'block'; });
        document.getElementById('parse-courses-btn').addEventListener('click', parsePastedCourseText);
        document.getElementById('add-master-course-btn').addEventListener('click', () => { document.getElementById('master-course-list').insertAdjacentHTML('beforeend', `<div class="master-course-item"><input type="text" class="master-course-name" placeholder="科目名"><input type="text" class="master-course-prof" placeholder="担当教員名"><button class="delete-btn">×</button></div>`); });
        document.getElementById('master-course-list').addEventListener('click', e => { if (e.target.classList.contains('delete-btn')) { e.target.closest('.master-course-item').remove(); } });
        courseMasterModalSaveBtn.addEventListener('click', saveCourseMasterData);
        [syllabusModal, lifetimeModal, courseMasterModal, notificationModal, recommendationModal].forEach(m => { m.querySelector('.close-btn').addEventListener('click', () => m.style.display = 'none'); window.addEventListener('click', e => { if (e.target === m) m.style.display = 'none'; }); });
        notificationBell.addEventListener('click', () => notificationModal.style.display = 'block');
        recommendTaskBtn.addEventListener('click', recommendNextTask);
        addTodoBtn.addEventListener('click', addTodo);
        todoInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addTodo(); });
        todoTableBody.addEventListener('click', e => { const target = e.target; const tr = target.closest('tr'); if (!tr) return; const todoId = parseInt(tr.dataset.id, 10); if (target.type === 'checkbox') { const todo = todoList.find(t => t.id === todoId); if (todo) todo.completed = target.checked; } else if (target.classList.contains('delete-btn')) { todoList = todoList.filter(t => t.id !== todoId); } renderTodoList(); });
        
        loadData();
    });
    </script>
</body>
</html>